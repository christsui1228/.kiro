# 客户订单分析功能需求文档

## 功能概述

为 OneManage 系统提供客户订单数据分析功能，支持按不同维度（客户来源、客户分组）和时间粒度（年、月）统计客户订单数量和金额，帮助业务人员快速了解客户价值分布和订单趋势。

## 业务目标

- 快速查看不同客户来源的订单贡献
- 分析客户分组的订单表现
- 追踪订单趋势的时间变化
- 为业务决策提供数据支持

## 验收标准（EARS 格式）

### REQ-001: 分析维度选择
**When** 用户打开客户订单分析页面  
**The system shall** 提供以下分析维度选项：
- 客户来源（流量/推荐）
- 客户分组（家庭/公司/其他）

**验收标准**：
- 用户可以通过单选按钮选择一个分析维度
- 默认选中"客户来源"
- 切换维度后，分析结果自动更新

### REQ-002: 时间粒度选择
**When** 用户配置分析参数  
**The system shall** 提供以下时间粒度选项：
- 不分组（汇总统计）
- 按年分组
- 按月分组

**验收标准**：
- 用户可以通过单选按钮选择时间粒度
- 默认选中"按月"
- 选择不同粒度后，数据按对应粒度聚合

### REQ-003: 时间范围筛选
**When** 用户需要查看特定时间段的数据  
**The system shall** 提供日期范围选择器

**验收标准**：
- 支持选择开始日期和结束日期
- 默认显示最近一年的数据
- 日期范围不能超过 3 年
- 开始日期不能晚于结束日期

### REQ-004: 订单数量统计
**When** 用户执行分析  
**The system shall** 计算并显示每个维度值的订单数量

**验收标准**：
- 订单数量为去重后的 order_id 数量
- 显示为整数格式
- 支持按订单数量排序

### REQ-005: 订单金额统计
**When** 用户执行分析  
**The system shall** 计算并显示每个维度值的累计订单金额和平均订单金额

**验收标准**：
- 累计金额为 order_amount 的总和
- 平均金额为累计金额除以订单数量
- 金额显示保留 2 位小数
- 支持按金额排序

### REQ-006: 表格展示
**When** 分析完成  
**The system shall** 在表格中展示分析结果

**验收标准**：
- 使用 Revo Grid 组件展示数据
- 表格列包括：维度值、时间周期（如有）、订单数量、累计金额、平均金额
- 支持列排序
- 支持列宽调整
- 数据量大时支持虚拟滚动

### REQ-007: 图表可视化
**When** 用户切换到图表视图  
**The system shall** 提供以下图表类型：
- 柱状图（对比不同维度的指标）
- 折线图（展示时间趋势）

**验收标准**：
- 使用 ECharts 渲染图表
- 柱状图显示订单数量和累计金额的对比
- 折线图显示时间序列的趋势变化
- 图表支持交互（hover 显示详情）
- 图表与表格数据一致

### REQ-008: 分析性能要求
**When** 用户执行分析  
**The system shall** 在 10 秒内返回结果

**验收标准**：
- 数据量在 10W 客户 + 50W 订单时，响应时间 < 5 秒
- 显示 Loading 状态
- 超时后显示友好的错误提示

### REQ-009: 数据准确性
**When** 系统计算统计指标  
**The system shall** 确保数据准确性

**验收标准**：
- 订单数量与数据库实际记录一致
- 金额计算精度为 2 位小数
- 时间分组逻辑正确（按订单创建时间）
- 客户维度关联正确

### REQ-010: 错误处理
**When** 分析过程中发生错误  
**The system shall** 显示友好的错误提示

**验收标准**：
- 网络错误：提示"网络连接失败，请稍后重试"
- 数据为空：提示"所选时间范围内无数据"
- 服务器错误：提示"系统繁忙，请稍后重试"
- 错误信息使用 Naive UI 的 Message 组件展示

## 功能范围

### 包含功能
- ✅ 客户来源维度分析
- ✅ 客户分组维度分析
- ✅ 时间粒度分组（年/月）
- ✅ 订单数量统计
- ✅ 订单金额统计（累计、平均）
- ✅ 表格展示（Revo Grid）
- ✅ 图表展示（ECharts 柱状图、折线图）
- ✅ 时间范围筛选

### 不包含功能（后续版本）
- ❌ 成本分析（毛利、快递成本）
- ❌ 复购率分析
- ❌ 客户生命周期价值
- ❌ 多维度交叉分析
- ❌ 导出 Excel/CSV
- ❌ 报表保存和分享
- ❌ 权限控制

## 数据来源

### 数据表
- `customers` 表：客户基础信息
  - customer_global_id（主键）
  - customer_source（客户来源）
  - group_type（客户分组）
  - customer_nickname（客户昵称）

- `orders` 表：订单信息
  - order_id（主键）
  - customer_global_id（外键）
  - order_amount（订单金额）
  - created_at（创建时间）

### 数据关系
- customers 与 orders 通过 customer_global_id 关联
- 一个客户可以有多个订单（1:N）

## 非功能性需求

### 性能要求
- 分析响应时间 < 5 秒（10W 客户 + 50W 订单）
- 表格渲染流畅（支持 10W 行虚拟滚动）
- 图表渲染时间 < 1 秒

### 可用性要求
- 界面简洁直观，无需培训即可使用
- 配置项清晰，有默认值
- 错误提示友好，有操作指引

### 兼容性要求
- 支持现代浏览器（Chrome、Firefox、Safari、Edge）
- 响应式布局，支持 1920x1080 及以上分辨率

### 可维护性要求
- 代码结构清晰，遵循项目规范
- 关键逻辑有注释说明
- 易于扩展新的维度和指标

## 约束条件

### 技术约束
- 后端使用 FastAPI + Polars
- 前端使用 Vue 3 + Naive UI + Revo Grid + ECharts
- 数据库为阿里云 RDS PostgreSQL（不能安装自定义扩展）
- 不使用 Redis 缓存

### 业务约束
- 暂不考虑权限控制（所有用户看到相同数据）
- 暂不支持多店铺数据隔离
- 时间范围限制在 3 年内

### 数据约束
- 订单数据量预估：50W 条
- 客户数据量预估：10W 条
- 数据实时性要求：可接受 1-2 秒延迟

## 用户角色

### 主要用户
- 运营人员：查看客户订单分布和趋势
- 管理人员：了解业务整体情况

### 使用场景
1. 每日查看昨日订单情况
2. 每周分析本周订单趋势
3. 每月对比不同客户来源的表现
4. 季度复盘客户价值分布

## 成功指标

- 分析功能上线后，运营人员每日使用率 > 80%
- 分析响应时间满足 < 5 秒要求
- 用户反馈界面易用性评分 > 4/5
- 数据准确性达到 100%（与数据库核对）
