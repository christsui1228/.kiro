# 需求文档

## 概述

本规格说明书旨在解决当前 TaskIQ + NATS 实现中的关键架构问题，通过统一消息架构为单一、连贯的系统。当前的双系统方法（独立的 TaskIQ 任务和事件订阅器）造成了复杂性、资源开销和可靠性问题，需要通过架构整合来解决。

## 术语表

- **TaskIQ系统**: 当前使用 NATS JetStream 进行异步任务处理的任务队列系统
- **事件系统**: 当前使用独立 NATS 流的事件发布/订阅系统
- **统一架构**: 提议的通过 TaskIQ 同时处理命令和事件的单一系统
- **命令任务**: 执行特定工作的 1:1 任务（替代当前的 @broker.task）
- **事件任务**: 广播完成事件的 1:N 通知任务（替代当前的 @subscribe_event）
- **TASKS流**: 用于命令/工作队列消息的 JetStream 流
- **EVENTS流**: 用于事件/通知消息的 JetStream 流
- **持久消费者**: 具有持久状态和唯一标识的 NATS JetStream 消费者
- **连接管理器**: 通过 core/broker.py 进行集中式 NATS 连接处理

## 需求

### 需求 1

**用户故事：** 作为系统架构师，我希望消除双重消息架构，以便系统具有更低的复杂性和资源开销。

#### 验收标准

1. 当系统启动时，连接管理器应当创建恰好两个 JetStream 流：TASKS流和EVENTS流
2. 连接管理器应当通过单一 broker 实例管理所有 NATS 连接
3. 事件系统应当被移除并替换为事件任务实现
4. TaskIQ系统应当同时处理命令执行和事件广播
5. 系统应当消除重复的 NATS 连接和流配置

### 需求 2

**用户故事：** 作为开发者，我希望命令和事件之间有清晰的分离，以便我能理解何时使用每种模式。

#### 验收标准

1. 当定义工作任务时，命令任务应当使用 TASKS流 和共享的持久消费者名称
2. 当定义事件监听器时，事件任务应当使用 EVENTS流 和唯一的持久消费者名称
3. 命令任务应当实现 1:1 执行语义，其中只有一个 worker 处理每条消息
4. 事件任务应当实现 1:N 广播语义，其中所有监听器都接收每个事件
5. 系统应当通过唯一的消费者标识防止事件监听器之间的消息抢占

### 需求 3

**用户故事：** 作为系统维护者，我希望版本感知的事件处理，以便模式变更不会破坏现有的事件处理器。

#### 验收标准

1. BaseEvent 类应当包含默认值为 "1.0" 的 event_version 字段
2. 当处理事件时，事件任务应当验证事件版本兼容性
3. 如果事件版本不受支持，那么事件任务应当记录警告并跳过处理
4. 事件任务应当接受原始字典载荷而不是类型化的 Pydantic 模型
5. 当事件模式演进时，系统应当支持优雅降级

### 需求 4

**用户故事：** 作为性能工程师，我希望轻量级的任务编排，以便重型处理不会阻塞任务队列。

#### 验收标准

1. 业务逻辑应当被提取到独立于 TaskIQ 的单独服务模块中
2. 命令任务应当保持轻量级并仅专注于编排和 I/O
3. 当处理复杂工作流时，系统应当将其分解为多个更小的命令任务
4. 工作流编排应当在相关任务之间使用顺序的 .kiq() 调用
5. 系统应当仅在所有工作流步骤成功后发布完成事件

### 需求 5

**用户故事：** 作为系统操作员，我希望统一的连接管理，以便 NATS 连接可靠且集中化。

#### 验收标准

1. 连接管理器应当在 worker 启动期间通过 TaskiqEvents.WORKER_STARTUP 初始化
2. events/publisher.py 应当使用共享的 broker.js 连接而不是创建新连接
3. 连接管理器应当在处理消息之前确保 TASKS流 和 EVENTS流 都存在
4. 系统应当消除 core/broker.py 之外的所有手动 NATS 连接管理
5. 连接管理器应当提供一致的错误处理和重连逻辑

### 需求 6

**用户故事：** 作为开发者，我希望无缝迁移现有的事件处理器，以便当前功能在过渡期间继续工作。

#### 验收标准

1. 系统应当提供从 @subscribe_event 装饰器到 @broker.task 实现的迁移路径
2. 现有的事件模式应当与新的事件任务模式保持兼容
3. 迁移应当保留所有当前的事件处理逻辑和行为
4. 系统应当支持在过渡期间临时运行新旧两种模式
5. 迁移应当包含每种转换模式的清晰文档和示例