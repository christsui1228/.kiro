# 实施计划

## 任务列表

- [x] 1. 重构统一连接管理器
  - 修改 `core/broker.py`，移除全局 stream_name 和 queue 配置
  - 添加 @broker.on_event(TaskiqEvents.WORKER_STARTUP) 钩子函数
  - 实现自动创建 TASKS 和 EVENTS 两个 JetStream 流的逻辑
  - 添加 ensure_stream 辅助函数用于流的创建和验证
  - _需求: 需求1.1, 需求1.2, 需求5.1, 需求5.3_

- [x] 2. 创建版本化事件基类
  - 修改 `events/schemas.py`，创建 BaseEvent 基类
  - 添加 event_version、timestamp、event_id 等元数据字段
  - 更新所有现有事件类继承 BaseEvent
  - 实现版本兼容性检查函数 is_version_compatible
  - _需求: 需求3.1, 需求3.5_

- [x] 3. 重构事件发布器使用统一连接
  - 修改 `events/publisher.py`，移除手动 NATS 连接逻辑
  - 导入并使用 core.broker.broker 的共享连接
  - 在 publish_event 函数中自动添加版本和时间戳信息
  - 实现统一的错误处理和日志记录
  - _需求: 需求1.3, 需求5.2, 需求5.5_

- [x] 4. 实现命令任务模式示例
  - 在 `OneManage/features/image_generator/services/parser/tasks.py` 中重构 PSD 解析任务
  - 使用 @broker.task 装饰器配置 TASKS 流和共享 durable_name
  - 将重型业务逻辑提取到独立的 service 模块
  - 实现轻量级的任务编排和错误处理
  - 添加工作流完成后的事件发布逻辑
  - _需求: 需求2.1, 需求2.3, 需求4.1, 需求4.2, 需求4.5_

- [x] 5. 实现事件任务模式示例
  - 创建新的事件处理任务替代现有的 @subscribe_event 装饰器
  - 使用 @broker.task 装饰器配置 EVENTS 流和唯一 durable_name
  - 实现原始字典载荷处理和版本兼容性检查
  - 确保多个事件监听器都能接收到同一事件
  - 添加优雅的错误处理和降级逻辑
  - _需求: 需求2.2, 需求2.4, 需求2.5, 需求3.2, 需求3.3, 需求3.4_

- [x] 6. 创建业务逻辑服务层
  - 在 `features/image_generator/services/parser/` 下创建 `psd_service.py`
  - 将 PSD 解析的核心业务逻辑从 tasks.py 中提取出来
  - 实现纯函数式的业务逻辑，不依赖 TaskIQ 或 NATS
  - 添加适当的类型注解和错误处理
  - _需求: 需求4.1, 需求4.2_

- [x] 7. 实现工作流编排模式
  - 创建工作流编排任务，使用顺序的 .kiq() 调用
  - 将复杂的 PSD 处理流程分解为多个小任务
  - 实现任务间的数据传递和错误传播
  - 确保只有在所有步骤成功后才发布完成事件
  - _需求: 需求4.3, 需求4.4, 需求4.5_

- [ ] 8. 清理旧系统组件
  - 删除 `events/client.py` 文件
  - 删除 `events/subscriber.py` 文件
  - 移除所有手动 NATS 连接管理代码
  - 更新相关的导入语句和依赖关系
  - _需求: 需求1.3, 需求5.4_

- [ ]* 9. 编写集成测试
  - 创建端到端的工作流测试
  - 测试命令任务和事件任务的交互
  - 验证版本兼容性和错误处理
  - 测试多 worker 环境下的负载均衡
  - _需求: 需求2.3, 需求2.4, 需求3.2_

- [ ]* 10. 性能基准测试
  - 对比新旧架构的性能差异
  - 测试高并发场景下的系统表现
  - 验证资源使用优化效果
  - 生成性能报告和优化建议
  - _需求: 需求1.1, 需求1.5_

- [ ]* 11. 创建监控和调试工具
  - 实现任务执行状态的可视化监控
  - 添加事件流转的追踪和调试功能
  - 创建系统健康检查和诊断工具
  - 设置关键指标的告警机制
  - _需求: 需求5.5_

- [ ]* 12. 编写迁移文档
  - 创建详细的迁移指南和最佳实践
  - 提供新架构的开发者文档
  - 编写故障排除和常见问题解答
  - 制作架构对比和决策说明文档
  - _需求: 需求6.5_