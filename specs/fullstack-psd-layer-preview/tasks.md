# 实施计划

- [x] 1. 完善 NATS 消息获取逻辑
  - 实现从 NATS 获取图层预览信息的核心逻辑
  - 添加 TTL 过期检查和错误处理机制
  - 实现消息订阅和查询功能
  - _需求: 2.1, 2.2, 3.2_

- [ ] 2. 实现图层预览 API 端点
- [x] 2.1 完善获取图层预览接口实现
  - 替换 `/tasks/{task_id}/layers-preview` 接口中的占位代码
  - 实现真实的 NATS 消息查询逻辑
  - 添加数据格式转换和验证
  - _需求: 4.1, 4.2_

- [x] 2.2 实现预览状态检查接口
  - 完善 `/tasks/{task_id}/layers-preview/status` 接口实现
  - 添加快速状态检查逻辑，无需获取完整数据
  - 实现预览就绪状态的准确判断
  - _需求: 4.2_

- [ ]* 2.3 编写 API 端点单元测试
  - 为图层预览 API 编写全面的单元测试
  - 测试各种错误场景和边界条件
  - 验证响应格式和状态码的正确性
  - _需求: 4.3_

- [ ] 3. 增强错误处理和容错机制
- [ ] 3.1 实现 NATS 降级策略
  - 当 NATS 不可用时，实现数据库查询降级
  - 添加服务健康检查和自动切换逻辑
  - 确保系统在 NATS 故障时仍能提供基本功能
  - _需求: 2.4, 5.1_

- [ ] 3.2 添加重试机制和指数退避
  - 为 NATS 事件发布实现重试逻辑
  - 实现指数退避算法，最多重试 3 次
  - 添加重试失败后的告警机制
  - _需求: 3.4, 5.2_

- [ ] 3.3 实现自动清理机制
  - 添加定时任务清理过期的 R2 文件
  - 实现存储空间监控和告警
  - 添加手动清理接口供管理员使用
  - _需求: 5.1, 5.3_

- [ ] 4. 性能优化和监控
- [ ] 4.1 优化并发上传性能
  - 调整 ThreadPoolExecutor 线程池大小配置
  - 实现动态线程池大小调整机制
  - 添加上传性能监控和统计
  - _需求: 6.1, 6.4_

- [ ] 4.2 添加 API 响应缓存
  - 为频繁访问的预览数据添加 Redis 缓存
  - 实现缓存失效和更新策略
  - 确保缓存数据的一致性
  - _需求: 1.3, 4.2_

- [ ]* 4.3 实现性能监控和指标收集
  - 添加 R2 上传成功率监控
  - 实现 API 响应时间统计
  - 添加 NATS 消息处理延迟监控
  - _需求: 6.2, 6.3_

- [ ] 5. 配置和部署优化
- [ ] 5.1 完善配置管理
  - 添加 R2 和 NATS 相关的环境变量配置
  - 实现配置验证和默认值设置
  - 添加配置文档和示例
  - _需求: 所有需求的部署支持_

- [ ] 5.2 添加健康检查端点
  - 实现系统健康检查接口
  - 检查 R2 存储连接状态
  - 检查 NATS 消息队列连接状态
  - _需求: 2.4, 5.4_

- [ ]* 5.3 编写部署文档和运维指南
  - 创建详细的部署配置文档
  - 编写故障排查和运维指南
  - 添加监控告警配置示例
  - _需求: 所有需求的运维支持_

- [ ] 6. 集成测试和验证
- [ ] 6.1 实现端到端集成测试
  - 编写完整的 PSD 上传到预览访问的集成测试
  - 测试 R2 上传、NATS 事件、API 查询的完整流程
  - 验证各组件之间的数据传递正确性
  - _需求: 1.1, 1.2, 1.3, 3.1_

- [ ]* 6.2 编写并发性能测试
  - 测试系统在高并发情况下的稳定性
  - 验证 100 个并发 PSD 处理任务的支持能力
  - 测试 API 在高负载下的响应性能
  - _需求: 6.3_

- [ ]* 6.3 实现错误场景测试
  - 测试 R2 存储不可用的场景
  - 测试 NATS 服务中断的场景
  - 验证各种网络故障的处理能力
  - _需求: 2.4, 5.1, 5.2_

- [ ] 7. 修复 bbox 数据格式不匹配问题
- [ ] 7.1 创建 bbox 格式标准化工具函数
  - 在 `features/image_generator/services/preview/` 创建 `utils.py`
  - 实现 `normalize_bbox()` 函数，支持元组、列表、字典格式转换
  - 添加类型验证和错误处理
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [x] 7.2 更新预览事件发布逻辑
  - 修改 `tasks.py` 中的 `publish_layers_preview_ready()` 函数
  - 在发布事件前对所有图层的 bbox 进行格式标准化
  - 确保发布到 NATS 的数据已经是前端兼容格式
  - _需求: 7.1, 7.3_

- [x] 7.3 更新 API 端点返回数据格式
  - 修改 `psd_upload_oss.py` 中的 `/tasks/{task_id}/result` 端点
  - 在返回数据前对 bbox 进行格式标准化
  - 确保 `layers_preview` 数组中的每个图层 bbox 格式正确
  - _需求: 7.1, 7.2_

- [x] 7.4 更新 PSD 解析服务的数据导出
  - 检查 `parser/psd_service.py` 中的图层数据构建逻辑
  - 确保从解析器输出到事件发布的整个链路使用统一格式
  - 添加数据格式验证日志
  - _需求: 7.3, 7.4_

- [ ]* 7.5 添加 bbox 格式转换的单元测试
  - 为 `normalize_bbox()` 函数编写全面的单元测试
  - 测试元组、列表、字典三种输入格式
  - 测试边界条件和错误输入
  - _需求: 7.4_

- [x] 7.6 验证前端数据接收和渲染
  - 在前端 `PsdCanvasPreview.vue` 添加 bbox 数据格式验证
  - 添加控制台日志输出接收到的 bbox 格式
  - 确认图层能够正确渲染在画布上
  - _需求: 7.1, 7.2_

- [ ] 8. 完成任务状态同步
  - 更新 `features/image_generator/task-management.md` 中 ID-003 任务状态为已完成
  - 添加 spec 实施完成的时间记录
  - 确保模块任务管理和 spec 任务状态保持一致
  - _需求: 任务管理规范_