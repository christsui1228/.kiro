# 需求文档

## 介绍

此功能让前端应用程序能够通过直接访问 R2 存储来预览 PSD 图层 PNG 文件，消除对后端代理的需求，并提供快速、可靠的图层预览能力。系统将在 PSD 解析完成后自动将图层 PNG 上传到 R2 存储，并使用 NATS 消息队列以 24 小时 TTL 机制传递图层 URL 信息。

## 需求

### 需求 1

**用户故事：** 作为前端开发者，我希望能够直接从 R2 存储访问 PSD 图层预览图片，以便我能够提供快速加载的预览体验，而无需后端瓶颈。

#### 验收标准

1. 当 PSD 解析完成时，系统应自动将所有图层 PNG 文件上传到 R2 存储
2. 当图层上传成功时，系统应生成 7 天有效期的签名 URL
3. 当前端请求图层预览时，系统应提供响应时间小于 100ms 的直接 R2 访问 URL
4. 如果某些图层的 R2 上传失败，系统应记录错误但继续处理其他图层

### 需求 2

**用户故事：** 作为系统管理员，我希望图层预览 URL 通过带有 TTL 机制的 NATS 消息队列进行管理，以便临时数据能够自动清理，系统资源得到高效管理。

#### 验收标准

1. 当图层上传完成时，系统应向 NATS 发布带有 24 小时 TTL 的图层预览就绪事件
2. 当 TTL 过期时，系统应自动从消息队列中移除图层 URL 信息
3. 当前端请求过期的预览数据时，系统应提供清晰的错误消息并建议重新上传
4. 如果 NATS 不可用，系统应优雅地降级到数据库存储

### 需求 3

**用户故事：** 作为前端用户，我希望在图层预览准备就绪时收到实时通知，以便我能够立即开始查看处理后的图层，而无需手动刷新。

#### 验收标准

1. 当所有图层都上传到 R2 时，系统应发布 PSD_LAYERS_PREVIEW_READY 事件
2. 当前端订阅预览事件时，系统应实时传递图层 URL 信息
3. 当预览数据包含图层元数据时，系统应提供图层名称、边界框、文件大小和索引信息
4. 如果事件传递失败，系统应使用指数退避重试最多 3 次

### 需求 4

**用户故事：** 作为开发者，我希望有全面的图层预览管理 API 端点，以便我能够将预览功能集成到不同的前端组件中。

#### 验收标准

1. 当请求图层预览时，API 应返回包含图层 URL 和元数据的结构化 JSON
2. 当检查预览状态时，API 应提供清晰的就绪/处理中/错误状态
3. 当处理错误时，API 应返回适当的 HTTP 状态码和描述性错误消息
4. 如果预览数据不可用，API 应建议适当的用户操作

### 需求 5

**用户故事：** 作为系统运维人员，我希望有自动清理和错误处理机制，以便系统保持稳定，存储成本得到控制。

#### 验收标准

1. 当签名 URL 过期时，系统应自动从 R2 清理临时文件
2. 当上传错误发生时，系统应实施带有指数退避的重试逻辑
3. 当系统资源不足时，系统应优先处理活跃的预览请求
4. 如果清理失败，系统应记录错误并警告管理员

### 需求 6

**用户故事：** 作为注重性能的用户，我希望有并发上传处理，以便包含多个图层的大型 PSD 文件能够快速处理。

#### 验收标准

1. 当上传多个图层时，系统应使用 10 个并发线程的 ThreadPoolExecutor
2. 当处理 7 个图层时，系统应在 1 秒内完成上传
3. 当处理并发请求时，系统应支持最多 100 个同时进行的 PSD 处理任务
4. 如果上传性能下降，系统应自动调整线程池大小

### 需求 7

**用户故事：** 作为前端开发者，我希望后端返回的图层 bbox 数据格式与前端组件期望的格式一致，以便我能够直接使用数据渲染图层预览，而无需额外的数据转换。

#### 验收标准

1. 当后端返回图层数据时，bbox 应包含 x1、y1、width、height、x2、y2 字段
2. 当前端接收 bbox 数据时，系统应确保所有字段都是数值类型
3. 当 bbox 数据从元组或列表格式转换时，系统应正确计算 x2 和 y2 坐标
4. 如果 bbox 数据格式不正确，系统应记录错误并提供默认值