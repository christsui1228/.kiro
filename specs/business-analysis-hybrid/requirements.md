# 业务分析混合架构需求文档

## 功能概述

基于**混合架构**重构业务分析功能，将数据探索和业务分析模型分离为两个独立的功能模块，各自使用最适合的技术栈。

## 核心理念

**两个独立的功能，两种不同的数据流**：

### 场景 A：数据探索（Perspective）
- **用户需求**：自由探索数据，拖拽分析，无需预设维度
- **数据流**：后端 Polars → Arrow IPC → 前端 Perspective（自由拖拽）
- **特点**：灵活、交互式、适合探索性分析

### 场景 B：业务分析模型（ECharts）
- **用户需求**：查看固定的业务指标图表，快速了解业务状况
- **数据流**：后端 Polars 计算 → JSON → 前端 ECharts（固定图表）
- **特点**：简单、直接、适合日常监控

## 术语表

- **Perspective**: FINOS 开源的高性能数据可视化引擎，支持自由拖拽分析
- **Arrow IPC**: Apache Arrow 的进程间通信格式，支持零拷贝数据传输
- **业务分析模型**: 预定义的分析维度和图表，用于日常业务监控
- **数据探索**: 用户自由选择维度和聚合方式的探索性分析
- **RFM 分析**: 基于 Recency（最近购买）、Frequency（购买频率）、Monetary（购买金额）三个维度的客户价值分析模型
- **复购分析**: 分析客户重复购买行为，包括复购率、复购周期、流失预警等指标
- **帕累托分析**: 基于 80/20 法则的分析方法，识别贡献最大的客户群体
- **波士顿矩阵**: 基于增长率和贡献度两个维度的客户/产品组合分析模型

## 验收标准（EARS 格式）

### 场景 A：数据探索功能

#### REQ-A001: 数据探索入口

**WHEN** 用户打开业务分析页面  
**THE system SHALL** 提供"数据探索"和"业务分析"两个 Tab 切换

**验收标准**：
1. 页面顶部显示 Tab 切换器
2. 默认显示"业务分析" Tab
3. 点击"数据探索" Tab 切换到 Perspective 视图
4. Tab 切换流畅，无闪烁

#### REQ-A002: Arrow 数据加载

**WHEN** 用户切换到"数据探索" Tab  
**THE system SHALL** 从后端加载 Arrow IPC 格式的原始数据

**验收标准**：
1. 调用 `/api/business-analysis/customer-orders/arrow` 接口
2. 接收 Arrow IPC 二进制数据
3. 数据包含所有维度列（customer_source, group_type, year, month, quarter 等）
4. 数据加载时间 < 2 秒（50W 行）
5. 显示 Loading 状态

#### REQ-A003: Perspective 自由拖拽

**WHEN** 用户在数据探索视图中操作  
**THE system SHALL** 支持自由拖拽列进行分析

**验收标准**：
1. 用户可以拖拽任意列到分组区域
2. 用户可以选择任意聚合方式（sum, avg, count 等）
3. 用户可以创建 Pivot 透视表
4. 用户可以动态筛选和排序
5. 操作响应时间 < 100ms
6. 无需后端参与

#### REQ-A004: 数据探索视图保存

**WHEN** 用户配置好分析视图  
**THE system SHALL** 支持保存和恢复视图配置

**验收标准**：
1. 用户可以保存当前视图配置
2. 用户可以为视图命名
3. 用户可以加载已保存的视图
4. 视图配置保存在 localStorage
5. 视图列表显示在侧边栏

### 场景 B：业务分析模型功能

#### REQ-B001: 业务分析模型入口

**WHEN** 用户打开业务分析页面  
**THE system SHALL** 默认显示"业务分析"Tab

**验收标准**：
1. 页面默认显示业务分析模型视图
2. 显示配置面板（维度选择、时间范围）
3. 显示固定的图表布局
4. 界面简洁直观

#### REQ-B002: 分析维度选择

**WHEN** 用户配置分析参数  
**THE system SHALL** 提供预定义的分析维度选项

**验收标准**：
1. 支持选择分组维度（客户来源 / 客户分组）
2. 支持选择时间粒度（不分组 / 按年 / 按月）
3. 支持选择时间范围（日期选择器）
4. 默认值：客户来源 + 按月 + 最近一年
5. 配置项清晰，有默认值

#### REQ-B003: 后端聚合计算

**WHEN** 用户点击"开始分析"  
**THE system SHALL** 调用后端接口进行聚合计算

**验收标准**：
1. 调用 `/api/business-analysis/customer-orders/analyze` 接口
2. 后端使用 Polars 进行聚合计算
3. 返回 JSON 格式的聚合结果
4. 响应时间 < 2 秒（50W 行原始数据）
5. 显示 Loading 状态

#### REQ-B004: ECharts 图表展示

**WHEN** 后端返回聚合数据  
**THE system SHALL** 使用 ECharts 渲染固定的图表

**验收标准**：
1. 显示柱状图（订单数量和金额对比）
2. 显示折线图（时间趋势，仅在有时间粒度时）
3. 显示数据表格（Naive UI DataTable）
4. 图表配置固定，无需用户调整
5. 图表渲染时间 < 500ms
6. 支持 Tooltip 交互

#### REQ-B005: 数据表格展示

**WHEN** 后端返回聚合数据  
**THE system SHALL** 在表格中展示分析结果

**验收标准**：
1. 使用 Naive UI DataTable 组件
2. 表格列包括：维度值、时间周期（如有）、订单数量、累计金额、平均金额
3. 支持列排序
4. 金额显示千分位分隔符
5. 金额保留 2 位小数

#### REQ-B006: 分析模型选择

**WHEN** 用户在业务分析 Tab 中操作  
**THE system SHALL** 提供多种分析模型供用户选择

**验收标准**：
1. 显示分析模型选择菜单（下拉菜单或侧边栏）
2. 支持的模型包括：基础聚合、RFM 分析、复购分析、帕累托分析、波士顿矩阵
3. 默认选中"基础聚合"模型
4. 切换模型时更新配置面板和图表区域
5. 模型切换流畅，无闪烁

#### REQ-B007: RFM 客户价值分析

**WHEN** 用户选择 RFM 分析模型  
**THE system SHALL** 使用 Polars 计算客户 RFM 指标并进行分层

**验收标准**：
1. 调用 `/api/business-analysis/rfm-analysis` 接口
2. 后端计算每个客户的 R（最近购买天数）、F（购买频次）、M（购买金额）
3. 使用分位数方法将客户分为 5 个等级（1-5）
4. 根据 RFM 组合将客户分为 8 个层级（重要价值客户、重要发展客户、重要保持客户、重要挽留客户、一般价值客户、一般发展客户、一般保持客户、一般挽留客户）
5. 返回客户分层统计和明细数据
6. 响应时间 < 2 秒

#### REQ-B008: RFM 分析可视化

**WHEN** 后端返回 RFM 分析结果  
**THE system SHALL** 使用 ECharts 展示客户分层情况

**验收标准**：
1. 显示饼图：各客户层级的数量分布
2. 显示柱状图：各客户层级的金额贡献
3. 显示散点图：R-F-M 三维分布（可选）
4. 显示数据表格：客户分层明细（层级、客户数、总金额、平均金额）
5. 支持点击图表查看该层级的客户列表

#### REQ-B009: 客户复购分析

**WHEN** 用户选择复购分析模型  
**THE system SHALL** 使用 Polars 计算客户复购指标

**验收标准**：
1. 调用 `/api/business-analysis/repurchase-analysis` 接口
2. 后端计算整体复购率（有复购的客户数 / 总客户数）
3. 计算平均复购周期（两次购买之间的平均天数）
4. 识别流失预警客户（超过平均周期 1.5 倍未购买）
5. 按客户来源/分组统计复购指标
6. 响应时间 < 2 秒

#### REQ-B010: 复购分析可视化

**WHEN** 后端返回复购分析结果  
**THE system SHALL** 使用 ECharts 展示复购情况

**验收标准**：
1. 显示指标卡片：整体复购率、平均复购周期、流失预警客户数
2. 显示柱状图：不同客户来源/分组的复购率对比
3. 显示折线图：复购周期分布（按天数区间统计客户数）
4. 显示数据表格：流失预警客户列表（客户昵称、最后购买日期、距今天数）
5. 支持导出流失预警客户列表

#### REQ-B011: 帕累托分析（80/20 法则）

**WHEN** 用户选择帕累托分析模型  
**THE system SHALL** 使用 Polars 识别核心客户群体

**验收标准**：
1. 调用 `/api/business-analysis/pareto-analysis` 接口
2. 后端按客户贡献金额降序排序
3. 计算累计贡献占比
4. 识别贡献 80% 金额的客户群体（核心客户）
5. 统计核心客户数量占比和金额占比
6. 响应时间 < 2 秒

#### REQ-B012: 帕累托分析可视化

**WHEN** 后端返回帕累托分析结果  
**THE system SHALL** 使用 ECharts 展示帕累托曲线

**验收标准**：
1. 显示帕累托图：柱状图（客户贡献金额）+ 折线图（累计占比）
2. 在 80% 位置标注分界线
3. 显示指标卡片：核心客户数量、核心客户占比、核心客户贡献金额、核心客户贡献占比
4. 显示数据表格：核心客户列表（排名、客户昵称、贡献金额、累计占比）
5. 支持导出核心客户列表

#### REQ-B013: 波士顿矩阵分析

**WHEN** 用户选择波士顿矩阵模型  
**THE system SHALL** 使用 Polars 进行客户组合分析

**验收标准**：
1. 调用 `/api/business-analysis/bcg-matrix` 接口
2. 后端计算每个客户的增长率（近期金额 vs 历史金额）
3. 计算每个客户的贡献度（占总金额的百分比）
4. 根据增长率和贡献度的中位数将客户分为四个象限：明星客户（高增长高贡献）、金牛客户（低增长高贡献）、问题客户（高增长低贡献）、瘦狗客户（低增长低贡献）
5. 返回四个象限的客户统计
6. 响应时间 < 2 秒

#### REQ-B014: 波士顿矩阵可视化

**WHEN** 后端返回波士顿矩阵分析结果  
**THE system SHALL** 使用 ECharts 展示客户分布矩阵

**验收标准**：
1. 显示散点图：X 轴为贡献度，Y 轴为增长率，每个点代表一个客户
2. 用不同颜色区分四个象限
3. 在中位数位置显示分界线
4. 显示气泡大小表示客户金额
5. 显示数据表格：四个象限的客户统计（象限名称、客户数、总金额、平均增长率）
6. 支持点击散点查看客户详情

### 通用需求

#### REQ-C001: 性能要求

**WHEN** 系统处理数据  
**THE system SHALL** 满足以下性能要求

**验收标准**：
1. 数据探索：Arrow 数据加载 < 2 秒（50W 行）
2. 数据探索：前端操作响应 < 100ms
3. 业务分析：后端聚合计算 < 2 秒（50W 行）
4. 业务分析：图表渲染 < 500ms
5. Tab 切换 < 100ms

#### REQ-C002: 缓存策略

**WHEN** 用户重复查询相同数据  
**THE system SHALL** 使用缓存加速响应

**验收标准**：
1. Arrow 数据使用 HTTP 缓存（ETag + Cache-Control）
2. 业务分析结果使用 HTTP 缓存
3. 缓存时间：1 小时（可配置）
4. 缓存命中响应 < 50ms
5. 显示缓存状态（命中/未命中）

#### REQ-C003: 错误处理

**WHEN** 分析过程中发生错误  
**THE system SHALL** 显示友好的错误提示

**验收标准**：
1. 网络错误：提示"网络连接失败，请稍后重试"
2. 数据为空：提示"所选时间范围内无数据"
3. 服务器错误：提示"系统繁忙，请稍后重试"
4. WebAssembly 加载失败：提示"浏览器不支持，请使用 Chrome 90+"
5. 所有错误都有明确的解决建议

#### REQ-C004: 用户引导

**WHEN** 用户首次使用功能  
**THE system SHALL** 提供操作引导

**验收标准**：
1. 首次打开显示功能介绍
2. 数据探索 Tab 显示拖拽操作提示
3. 业务分析 Tab 显示配置说明
4. 提供帮助文档链接
5. 用户可以关闭引导

## 功能范围

### 场景 A：数据探索（包含功能）
- ✅ Arrow IPC 数据加载
- ✅ Perspective 4.0 集成
- ✅ 自由拖拽分析
- ✅ 动态聚合计算
- ✅ Pivot 透视表
- ✅ 动态筛选和排序
- ✅ 多视图支持（表格、透视、图表）
- ✅ 视图保存和恢复
- ✅ 数据导出（CSV、JSON、Arrow）

### 场景 B：业务分析模型（包含功能）
- ✅ 预定义分析维度
- ✅ 后端 Polars 聚合计算
- ✅ JSON 数据传输
- ✅ ECharts 固定图表（柱状图、折线图、饼图、散点图）
- ✅ Naive UI 数据表格
- ✅ 时间范围筛选
- ✅ 配置面板
- ✅ 多种分析模型选择
- ✅ **RFM 客户价值分析**（P0）
- ✅ **客户复购分析**（P0）
- ✅ **帕累托分析（80/20 法则）**（P0）
- ✅ **波士顿矩阵分析**（P2）

### 不包含功能（后续版本）
- ❌ 实时数据流（WebSocket）
- ❌ 协作功能（多用户同时分析）
- ❌ 权限控制
- ❌ 自定义计算字段（公式编辑器）
- ❌ AI 驱动的洞察
- ❌ 移动端适配

## 数据来源

### 数据表
- `customers` 表：客户基础信息（~10W 行）
  - customer_global_id（主键）
  - customer_source（客户来源）
  - group_type（客户分组）
  - customer_nickname（客户昵称）

- `orders` 表：订单信息（~30W 行）
  - order_id（主键）
  - customer_global_id（外键）
  - order_amount（订单金额）
  - created_at（创建时间）

### 数据关系
- customers 与 orders 通过 customer_global_id 关联
- 一个客户可以有多个订单（1:N）

## 非功能性需求

### 性能要求
- 数据探索：Arrow 数据加载 < 2 秒（50W 行）
- 数据探索：前端操作响应 < 100ms
- 业务分析：后端聚合计算 < 2 秒（50W 行）
- 业务分析：图表渲染 < 500ms
- 缓存命中响应 < 50ms

### 可用性要求
- 界面直观，两个场景清晰分离
- 数据探索：支持拖拽操作，有操作提示
- 业务分析：配置简单，有默认值
- 错误提示友好，有解决建议

### 兼容性要求
- 支持现代浏览器（Chrome 90+、Firefox 88+、Safari 14+、Edge 90+）
- 数据探索需要 WebAssembly 支持
- 业务分析无特殊要求
- 响应式布局，支持 1920x1080 及以上分辨率

### 可维护性要求
- 代码结构清晰，两个场景独立
- 关键逻辑有注释说明
- 易于扩展新的分析模型
- 易于添加新的图表类型

## 约束条件

### 技术约束
- 后端使用 FastAPI + Polars + PyArrow
- 前端使用 Vue 3 + Naive UI + Perspective 4.0 + ECharts 6.0
- 数据库为 PostgreSQL（不能安装自定义扩展）
- 使用 HTTP 缓存（无需 Redis）

### 业务约束
- 暂不考虑权限控制
- 暂不支持多店铺数据隔离
- 数据实时性要求：实时查询数据库

### 数据约束
- 订单数据量当前：30W 条
- 客户数据量当前：10W 条
- 单次查询数据量限制：最多 50W 行

## 架构设计

### 数据流对比

**场景 A：数据探索**
```
后端 Polars 查询原始数据
    ↓
Arrow IPC 序列化
    ↓
HTTP 响应（带 ETag 缓存）
    ↓
前端 Perspective 加载
    ↓
用户自由拖拽分析
    ↓
Perspective 内部计算聚合
```

**场景 B：业务分析模型**
```
后端 Polars 查询原始数据
    ↓
Polars 聚合计算
    ↓
JSON 序列化
    ↓
HTTP 响应（带缓存）
    ↓
前端接收 JSON
    ↓
ECharts 渲染固定图表
```

### 关键差异

| 维度 | 场景 A：数据探索 | 场景 B：业务分析模型 |
|------|-----------------|-------------------|
| 数据格式 | Arrow IPC（二进制） | JSON（文本） |
| 数据内容 | 原始明细数据 | 聚合后的结果 |
| 计算位置 | 前端（Perspective） | 后端（Polars） |
| 灵活性 | 高（自由拖拽） | 低（固定图表） |
| 性能 | 首次加载慢，后续快 | 每次都需要后端计算 |
| 适用场景 | 探索性分析 | 日常监控 |

## 成功指标

- 数据探索功能使用率 > 30%（高级用户）
- 业务分析功能使用率 > 90%（所有用户）
- 数据探索操作响应时间 < 100ms（达成率 > 95%）
- 业务分析响应时间 < 2 秒（达成率 > 95%）
- 缓存命中率 > 80%
- 用户满意度 > 4.5/5
- 系统可用性 > 99.5%

## 用户角色

### 主要用户
- **运营人员**：主要使用业务分析模型，查看固定图表
- **数据分析师**：主要使用数据探索，进行深度分析
- **管理人员**：两者都用，了解业务整体情况

### 使用场景

**业务分析模型（高频）**：
1. 每日查看昨日订单情况（基础聚合）
2. 每周分析本周订单趋势（基础聚合）
3. 每月对比不同客户来源的表现（基础聚合）
4. 每月进行客户价值分层（RFM 分析）
5. 每周识别流失预警客户（复购分析）
6. 每季度识别核心客户群体（帕累托分析）
7. 每季度进行客户组合分析（波士顿矩阵）

**数据探索（低频）**：
1. 季度复盘，深度分析客户价值分布
2. 发现异常数据，进行根因分析
3. 探索新的分析维度和指标

## 迁移策略

### 从现有系统迁移

**现有系统**：
- `business-analysis`：基于 Revo Grid + ECharts 的旧版本
- `business-analysis-v2`：基于 Perspective 的新版本

**迁移计划**：
1. 创建新的 `business-analysis-v3` 模块（混合架构）
2. 保留旧版本，逐步引导用户迁移
3. 3 个月后评估使用情况，决定是否下线旧版本

### 数据兼容性

- 后端接口保持兼容
- 前端组件独立开发
- 数据格式向后兼容

## 风险评估

### 技术风险
- **风险**：Perspective WebAssembly 加载失败
- **缓解**：提供降级方案，显示友好提示

### 性能风险
- **风险**：数据量增长导致性能下降
- **缓解**：实施分页加载、物化视图、Redis 缓存

### 用户体验风险
- **风险**：两个场景切换导致用户困惑
- **缓解**：提供清晰的功能说明和操作引导

## 后续优化方向

### 短期（1-3 个月）
- 优化缓存策略
- 完善现有分析模型（RFM、复购、帕累托、波士顿矩阵）
- 优化 WebAssembly 加载速度

### 中期（3-6 个月）
- 添加更多分析模型（渠道转化分析、销售趋势分析）
- 实现视图分享功能
- 添加数据导出功能
- 实现权限控制

### 长期（6-12 个月）
- 引入物化视图（数据量 > 100W）
- 实现实时数据流（WebSocket）
- 添加 AI 驱动的洞察
- 支持自定义分析模型配置
